#!/bin/bash

# MindLog Pre-push Hook
# Runs affected tests before pushing to prevent CD pipeline failures.
# Skip: MINDLOG_SKIP_TESTS=1 git push  OR  git push --no-verify

set -e

ROOT_DIR=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$ROOT_DIR" ]; then
    echo "Warning: Not a git repository. Skipping pre-push hook."
    exit 0
fi

# Emergency skip with audit trail
if [ "$MINDLOG_SKIP_TESTS" = "1" ]; then
    echo ""
    echo -e "\033[1;33m[pre-push] WARNING: Tests skipped via MINDLOG_SKIP_TESTS=1\033[0m"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] pre-push skipped (MINDLOG_SKIP_TESTS)" >> "$ROOT_DIR/.git/hook-audit.log"
    exit 0
fi

# Parse stdin to detect tag-only pushes
TAG_ONLY=true
while read -r local_ref local_sha remote_ref remote_sha; do
    if [[ "$local_ref" != refs/tags/* ]]; then
        TAG_ONLY=false
    fi
done

if [ "$TAG_ONLY" = true ]; then
    exit 0
fi

# Check for changed Dart files
cd "$ROOT_DIR"

CHANGED_DART=$(git diff --name-only origin/main...HEAD -- '*.dart' 2>/dev/null || \
               git diff --name-only HEAD~1...HEAD -- '*.dart' 2>/dev/null || \
               echo "")

if [ -z "$CHANGED_DART" ]; then
    echo "[pre-push] No Dart file changes detected. Skipping tests."
    exit 0
fi

echo ""
echo -e "\033[0;32m[pre-push] Running affected tests before push...\033[0m"
echo ""

# Run affected tests via run.sh
if ! "$ROOT_DIR/scripts/run.sh" test-affected --no-analyze; then
    echo ""
    echo -e "\033[0;31m[pre-push] Tests FAILED. Push blocked.\033[0m"
    echo ""
    echo "Options:"
    echo "  1. Fix failing tests and try again"
    echo "  2. git push --no-verify    (skip hook entirely)"
    echo "  3. MINDLOG_SKIP_TESTS=1 git push  (skip with audit log)"
    echo ""
    exit 1
fi

echo ""
echo -e "\033[0;32m[pre-push] All affected tests passed.\033[0m"
exit 0
